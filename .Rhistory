install.packages("rstac")
install.packages("gdalcubes")
install.packages("stars")
install.packages("tmap")
library(rstac)
library(gdalcubes)
library(stars)
library(tmap)
library(dplyr)
gdalcubes::gdalcubes_options(parallel = TRUE)
box = c(xmin=-122.51, ymin=37.71, xmax=-122.36, ymax=37.81)
start_date = "2022-06-01"
end_date = "2022-08-01"
items =
stac("https://earth-search.aws.element84.com/v0/") |>
stac_search(collections = "sentinel-s2-l2a-cogs",
bbox = box,
datetime = paste(start_date, end_date, sep="/"),
limit = 100) |>
ext_query("eo:cloud_cover" < 20) |>
post_request()
col = stac_image_collection(items$features, asset_names = c("B08", "B04", "SCL"))
cube = cube_view(srs ="EPSG:4326",
extent = list(t0 = start_date, t1 = end_date,
left = box[1], right = box[3],
top = box[4], bottom = box[2]),
dx = 0.0001, dy = 0.0001, dt = "P1D",
aggregation = "median", resampling = "average")
mask = image_mask("SCL", values=c(3, 8, 9)) # mask clouds and cloud shadows
data =  raster_cube(col, cube, mask = mask)
ndvi = data |>
select_bands(c("B04", "B08")) |>
apply_pixel("(B08-B04)/(B08+B04)", "NDVI") |>
reduce_time(c("mean(NDVI)"))
ndvi_stars = st_as_stars(ndvi)
mako = tm_scale_continuous(values = viridisLite::mako(30))
fill = tm_scale_continuous(values = "Greens")
tm_shape(ndvi_stars) + tm_raster(col.scale = mako)
install.packages("sits")
library(sits)
roi <- c(
lon_min = -43.5526, lat_min = -2.9644,
lon_max = -42.5124, lat_max = -2.1671
)
# Select the cube
s2_L8_cube_MPC <- sits_cube(
source = "MPC",
collection = "LANDSAT-C2-L2",
bands = c("BLUE", "RED", "GREEN", "NIR08", "SWIR16", "CLOUD"),
roi = roi,
start_date = "2019-06-01",
end_date = "2019-09-01"
)
items =
stac("https://planetarycomputer.microsoft.com/api/stac/v1/collections/landsat-c2-l2") |>
stac_search(bbox = box,
datetime = paste(start_date, end_date, sep="/"),
limit = 100) |>
ext_query("eo:cloud_cover" < 20) |>
post_request()
items =
stac("https://planetarycomputer.microsoft.com/api/stac/v1/collections/landsat-c2-l2") |>
stac_search(bbox = box,
datetime = paste(start_date, end_date, sep="/"),
limit = 100)
col = stac_image_collection(items$features, asset_names = c("B08", "B04", "SCL"))
install.packages("sf")
setwd("~/Desktop/FireME")
library(terra)
setwd("~/Desktop/NPS/Fireseverity")
setwd("~/Desktop/NPS/Fireseverity/validation_EurekaFire")
setwd("~/Desktop/NPS/Fireseverity/validation_EurekaFire")
library(tidyverse)
library(sf)
library(terra)
library(tidyterra)
NDVI = function(raster) {
ndvi_r = (raster[[4]] - raster[[3]]) / (raster[[4]] + raster[[3]])
return(ndvi_r)
}
raster_prefire = terra::rast('PlanetScope/2025-05-27_strip_8094341_composite_file_format.tif')
raster_postfire = terra::rast('PlanetScope/2025-06-09_strip_8121430_composite_file_format.tif')
NDVI_prefire = NDVI(raster_prefire)
NDVI_postfire = NDVI(raster_postfire)
p_prefire = ggplot() + theme_bw() + ggtitle('NDVI Pre-Fire (May 27, 2025)') +
geom_spatraster(data = NDVI_prefire) +
scico::scale_fill_scico(name = 'NDVI', palette = 'batlow',
direction = -1, limits = c(0, 0.34)) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom')
p_postfire = ggplot() + theme_bw() + ggtitle('NDVI Post-Fire (June 9, 2025)') +
geom_spatraster(data = NDVI_postfire) +
scico::scale_fill_scico(name = 'NDVI', palette = 'batlow',
direction = -1, , limits = c(0, 0.34)) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom')
NDndvi= (NDVI_prefire - NDVI_postfire)/ NDVI_prefire
plot(NDndvi)
p_diff = ggplot() + theme_bw() + ggtitle('NDVI Pre-Fire (May 27, 2025)') +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'NDVI', palette = 'roma', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom')
(p_diff = ggplot() + theme_bw() + ggtitle('normalized difference NDVI') +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'NDVI', palette = 'roma', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle('normalized difference NDVI') +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'NDVI', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
plot = cowplot::plot_grid(p_prefire, p_postfire, p_diff, ncol = 3)
plot
(p_diff = ggplot() + theme_bw() + ggtitle('normalized difference NDVI') +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression('NDVI'[pre])) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI'[pre]' - NDVI'[post]' / NDVI'[pre])) +
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI'[pre]' - NDVI'[post] ' / NDVI'[pre])) +
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI'~[pre]~' - NDVI'~[post]~' / NDVI'~[pre])) +
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI'[pre]' - NDVI')) +
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI'[pre])) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI'[pre]NDVI)) +
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI'[pre]' - NDVI')) +
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI' [pre] ' - NDVI')) +
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI' [pre]~' - NDVI')) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI' [pre]~' - NDVI' [post])) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI' [pre]~' - NDVI' [post]~')')) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression('(NDVI' [pre]~' - NDVI' [post]~') / NDVI' [pre])) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression('n'[Delta]~' = (NDVI' [pre]~' - NDVI' [post]~') / NDVI' [pre])) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression('n'Delta~' = (NDVI' [pre]~' - NDVI' [post]~') / NDVI' [pre])) +
(p_diff = ggplot() + theme_bw() + ggtitle(expression(Delta~' = (NDVI' [pre]~' - NDVI' [post]~') / NDVI' [pre])) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression(Delta[n]~' = (NDVI' [pre]~' - NDVI' [post]~') / NDVI' [pre])) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = 'nD', palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
(p_diff = ggplot() + theme_bw() + ggtitle(expression(Delta[n]~' = (NDVI' [pre]~' - NDVI' [post]~') / NDVI' [pre])) +
geom_spatraster(data = NDndvi) +
scico::scale_fill_scico(name = expression(Delta[n]), palette = 'vik', midpoint = 0,
direction = -1) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0)) +
theme(legend.position = 'bottom'))
